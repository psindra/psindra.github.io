<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css">
    <title>Form and Table</title>
    <style>
        @media (max-width: 576px) {
            .flex-wrap {
                flex-wrap: wrap;
            }
        }
      input#enableConsole:not(:checked)+pre#preConsole{
        display: none;
      }
    </style>
    <script defer src="errorRender.js" ></script>
    <script defer src="./class_barcodeDetector.js"></script>
    <script defer src="./index_class.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h2>Form</h2>
                <form id="myForm">
                    <input type="hidden" id="rowId">
                    <div class="form-group">
                        <label for="barcodeProducto">Barcode:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="barcodeProducto" required>
                            <button type="button" class="btn btn-outline-secondary" id="scanBtn">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera" viewBox="0 0 16 16">
                                <path
                                    d="M5.75 2A1.75 1.75 0 0 0 4 3.75v2.5A1.75 1.75 0 0 0 5.75 8h1.5A1.75 1.75 0 0 0 9 6.25v-2.5A1.75 1.75 0 0 0 7.25 2h-1.5zM6 4a.75.75 0 1 1 0-1.5A.75.75 0 0 1 6 4zm4.854-.146a.5.5 0 0 1 .353-.147h1.939a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5h-1.939a.5.5 0 0 1-.353-.147l-1.18-1.18a.5.5 0 0 0-.707 0l-2.147 2.147a.5.5 0 0 1-.707 0L4.146 9.854a.5.5 0 0 1 0-.707L6.293 7.5a.5.5 0 0 0 0-.707L4.146 5.146a.5.5 0 0 1 0-.707l1.18-1.18a.5.5 0 0 0 0-.707L4.646.646a.5.5 0 0 0-.707 0L1.793 3.793a1.5 1.5 0 0 0 0 2.122l2.147 2.147a.5.5 0 0 1 0 .707l-1.18 1.18a.5.5 0 0 0 0 .707l2.147 2.147a.5.5 0 0 1 .707 0l2.147-2.147a.5.5 0 0 0 .707 0l1.18 1.18a.5.5 0 0 0 .707 0L11.854 9.854a1.5 1.5 0 0 0 0-2.122L9.707 5.585a.5.5 0 0 1 0-.707l2.147-2.147z" />
                              </svg>
                            </button>
                          </div>
                    </div>
                    <div class="form-group">
                        <label for="descripcionProducto">Description:</label>
                        <input type="text" class="form-control" id="descripcionProducto" required>
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Qty:</label>
                        <input type="number" class="form-control" id="cantidad" step=".01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="precio">Price:</label>
                        <input type="number" class="form-control" id="precio" step=".01" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                </form>
            </div>
            <dialog id="scanDialog"  class="w-75 h-75 m-auto">
                <div class="m-auto d-flex flex-column justify-content-evenly h-100">
                    <video id="scanVideo" muted autoplay="autoplay" playsinline="playsinline" webkit-playsinline width="100%"></video>
                    <button id="closeDialogBtn" class="btn btn-secondary">Close</button>
                </div>
              </dialog>
            <div class="col-md-6">
                <h2>Total <span id="total"></span></h2>
                
                <table id="dataTable" class="table">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <br><br>
    <hr>
    <button id="cleanConsole">Clean Console</button> <input type="checkbox" id="enableConsole" name="enableConsole">
    <pre id="preConsole">
    </pre>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("myForm");
            const rowIdInput = document.getElementById("rowId");
            const barcodeInput = document.getElementById("barcodeProducto");
            const descriptionInput = document.getElementById("descripcionProducto");
            const cantidadInput = document.getElementById("cantidad");
            const priceInput = document.getElementById("precio");
            const dataTable = document.getElementById("dataTable").getElementsByTagName("tbody")[0];
            const cancelBtn = document.getElementById("cancelBtn");

            let editingRowId = null;

            form.addEventListener("submit", (event) => {
                event.preventDefault();

                const barcode = barcodeInput.value;
                const description = descriptionInput.value;
                const cantidad = cantidadInput.value;
                const price = priceInput.value;

                const formData = {
                        barcodeProducto: Number(barcode),
                        descripcionProducto: description,
                        historicoPrecios: [{precio: Number(price), cantidad: Number(cantidad)}],
                    };

                if (editingRowId) {
                    // Update existing row
                    const existingRow = document.getElementById(`row-${editingRowId}`);
                    existingRow.innerHTML = `
                        <td>${barcode}</td>
                        <td>${description}</td>
                        <td>${cantidad}</td>
                        <td>${price}</td>
                        <td>
                        <button type="button" class="btn btn-sm btn-primary edit-btn" data-id="${editingRowId}">Edit</button>
                        <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="${editingRowId}">Delete</button>
                        </td>
                    `;

                    // const formData = {
                    //     barcodeProducto: Number(barcode),
                    //     descripcionProducto: description,
                    //     precio: Number(price),
                    //     _id: editingRowId,
                    // };

                    formData["_id"] = editingRowId;

                    fetch(`/api/detalleProducto/${editingRowId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(formData)
                    })

                    // Clear the form fields and editing state
                    cancelEditing();
                } else {
                    // Add new row
                    // const formData = {
                    //     barcodeProducto: Number(barcode),
                    //     descripcionProducto: description,
                    //     precio: Number(price),
                    // };

                    fetch("/api/detalleProducto", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(formData)
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            const rowId = data._id; // Assuming the JSON response has an 'id' property
                            const row = document.createElement("tr");
                            row.innerHTML = `
                <td>${data.barcodeProducto}</td>
                <td>${data.descripcionProducto}</td>
                <td>${data.historicoPrecios[0].cantidad}</td>
                <td>${data.historicoPrecios[0].precio}</td>
                <td>
                  <button type="button" class="btn btn-sm btn-primary edit-btn" data-id="${rowId}">Edit</button>
                  <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="${rowId}">Delete</button>
                </td>
              `;
                            row.id = `row-${rowId}`;
                            dataTable.appendChild(row);

                            // Clear the form fields
                            barcodeInput.value = "";
                            descriptionInput.value = "";
                            priceInput.value = "";
            updateTotal();

                        })
                        .catch(() => {
                            alert("Error submitting the form");
                        });
                }

            updateTotal();
            });

            cancelBtn.addEventListener("click", () => {
                cancelEditing();
            });

            dataTable.addEventListener("click", (event) => {
                const target = event.target;
                if (target.classList.contains("edit-btn")) {
                    const rowId = target.getAttribute("data-id");
                    const row = document.getElementById(`row-${rowId}`);
                    const barcode = row.cells[0].innerText;
                    const description = row.cells[1].innerText;
                    const price = row.cells[2].innerText;

                    // Set the form fields with the selected row's data
                    rowIdInput.value = rowId;
                    barcodeInput.value = barcode;
                    descriptionInput.value = description;
                    priceInput.value = price;

                    // Set the editing state
                    editingRowId = rowId;
                } else if (target.classList.contains("delete-btn")) {
                    const rowId = target.getAttribute("data-id");
                    const row = document.getElementById(`row-${rowId}`);
                    
                    fetch(`/api/detalleProducto/${rowId}`, {
                        method: "DELETE",
                        body: JSON.stringify({_id: rowId})
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        alert(JSON.stringify({eliminado: data}));
                        row.remove();
                    });
                }

                updateTotal();
            });

            function cancelEditing() {
                editingRowId = null;
                rowIdInput.value = "";
                barcodeInput.value = "";
                descriptionInput.value = "";
                priceInput.value = "";
            }

            fetch("/api/detalleProducto", {
                method: "GET",

                headers: {
                    "Content-Type": "application/json"
                },
            })
                .then((response) => response.json())
                .then((datas) => {
                    datas.forEach(data => {
                        const rowId = data._id; // Assuming the JSON response has an 'id' property
                        const row = document.createElement("tr");
                        row.innerHTML = `
                <td>${data.barcodeProducto}</td>
                <td>${data.descripcionProducto}</td>
                <td>${data.precio}</td>
                <td>
                  <button type="button" class="btn btn-sm btn-primary edit-btn" data-id="${rowId}">Edit</button>
                  <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="${rowId}">Delete</button>
                </td>
              `;
                        row.id = `row-${rowId}`;
                        dataTable.appendChild(row);
                    });

                    // Clear the form fields
                    barcodeInput.value = "";
                    descriptionInput.value = "";
                    priceInput.value = "";
            updateTotal();

                })
                .catch(() => {
                    alert("Error submitting the form");
                })


            function updateTotal() {
                let total = 0;
                const rows = dataTable.getElementsByTagName("tr");

                for (let i = 0; i < rows.length; i++) {
                    const priceCell = rows[i].getElementsByTagName("td")[2];
                    const price = parseFloat(priceCell.innerText);
                    if (!isNaN(price)) {
                        total += price;
                    }
                }

                // Update the total value
                const totalElement = document.getElementById("total");
                totalElement.innerText = total.toFixed(2); // Assuming 2 decimal places
            }


            const scanBtn = document.getElementById("scanBtn");
            const scanDialog = document.getElementById("scanDialog");
            const scanVideo = document.getElementById("scanVideo");
            const closeDialogBtn = document.getElementById("closeDialogBtn");
            scanBtn.addEventListener("click", () => {
                scanDialog.showModal();
                playCamera();
            });

            closeDialogBtn.addEventListener("click", () => {
                stopCamera()
                scanDialog.close();
            });



            updateTotal();

        });
    </script>
</body>

</html>